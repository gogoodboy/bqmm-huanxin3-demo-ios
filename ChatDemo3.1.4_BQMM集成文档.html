<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<style type="text/css">
.ef0,.f0 { color: #000000; } .eb0,.b0 { background-color: #000000; }
.ef1,.f1 { color: #AA0000; } .eb1,.b1 { background-color: #AA0000; }
.ef2,.f2 { color: #00AA00; } .eb2,.b2 { background-color: #00AA00; }
.ef3,.f3 { color: #AA5500; } .eb3,.b3 { background-color: #AA5500; }
.ef4,.f4 { color: #0000AA; } .eb4,.b4 { background-color: #0000AA; }
.ef5,.f5 { color: #AA00AA; } .eb5,.b5 { background-color: #AA00AA; }
.ef6,.f6 { color: #FF55FF; } .eb6,.b6 { background-color: #FF55FF; }
.ef7,.f7 { color: #AAAAAA; } .eb7,.b7 { background-color: #AAAAAA; }
.ef8, .f0 > .bold,.bold > .f0 { color: #555555; font-weight: normal; }
.ef9, .f1 > .bold,.bold > .f1 { color: #FF5555; font-weight: normal; }
.ef10,.f2 > .bold,.bold > .f2 { color: #55FF55; font-weight: normal; }
.ef11,.f3 > .bold,.bold > .f3 { color: #FFFF55; font-weight: normal; }
.ef12,.f4 > .bold,.bold > .f4 { color: #5555FF; font-weight: normal; }
.ef13,.f5 > .bold,.bold > .f5 { color: #FF55FF; font-weight: normal; }
.ef14,.f6 > .bold,.bold > .f6 { color: #55FFFF; font-weight: normal; }
.ef15,.f7 > .bold,.bold > .f7 { color: #FFFFFF; font-weight: normal; }
.eb8  { background-color: #555555; }
.eb9  { background-color: #FF5555; }
.eb10 { background-color: #55FF55; }
.eb11 { background-color: #FFFF55; }
.eb12 { background-color: #5555FF; }
.eb13 { background-color: #FF55FF; }
.eb14 { background-color: #55FFFF; }
.eb15 { background-color: #FFFFFF; }
.ef16 { color: #000000; } .eb16 { background-color: #000000; }
.ef17 { color: #00005f; } .eb17 { background-color: #00005f; }
.ef18 { color: #000087; } .eb18 { background-color: #000087; }
.ef19 { color: #0000af; } .eb19 { background-color: #0000af; }
.ef20 { color: #0000d7; } .eb20 { background-color: #0000d7; }
.ef21 { color: #0000ff; } .eb21 { background-color: #0000ff; }
.ef22 { color: #005f00; } .eb22 { background-color: #005f00; }
.ef23 { color: #005f5f; } .eb23 { background-color: #005f5f; }
.ef24 { color: #005f87; } .eb24 { background-color: #005f87; }
.ef25 { color: #005faf; } .eb25 { background-color: #005faf; }
.ef26 { color: #005fd7; } .eb26 { background-color: #005fd7; }
.ef27 { color: #005fff; } .eb27 { background-color: #005fff; }
.ef28 { color: #008700; } .eb28 { background-color: #008700; }
.ef29 { color: #00875f; } .eb29 { background-color: #00875f; }
.ef30 { color: #008787; } .eb30 { background-color: #008787; }
.ef31 { color: #0087af; } .eb31 { background-color: #0087af; }
.ef32 { color: #0087d7; } .eb32 { background-color: #0087d7; }
.ef33 { color: #0087ff; } .eb33 { background-color: #0087ff; }
.ef34 { color: #00af00; } .eb34 { background-color: #00af00; }
.ef35 { color: #00af5f; } .eb35 { background-color: #00af5f; }
.ef36 { color: #00af87; } .eb36 { background-color: #00af87; }
.ef37 { color: #00afaf; } .eb37 { background-color: #00afaf; }
.ef38 { color: #00afd7; } .eb38 { background-color: #00afd7; }
.ef39 { color: #00afff; } .eb39 { background-color: #00afff; }
.ef40 { color: #00d700; } .eb40 { background-color: #00d700; }
.ef41 { color: #00d75f; } .eb41 { background-color: #00d75f; }
.ef42 { color: #00d787; } .eb42 { background-color: #00d787; }
.ef43 { color: #00d7af; } .eb43 { background-color: #00d7af; }
.ef44 { color: #00d7d7; } .eb44 { background-color: #00d7d7; }
.ef45 { color: #00d7ff; } .eb45 { background-color: #00d7ff; }
.ef46 { color: #00ff00; } .eb46 { background-color: #00ff00; }
.ef47 { color: #00ff5f; } .eb47 { background-color: #00ff5f; }
.ef48 { color: #00ff87; } .eb48 { background-color: #00ff87; }
.ef49 { color: #00ffaf; } .eb49 { background-color: #00ffaf; }
.ef50 { color: #00ffd7; } .eb50 { background-color: #00ffd7; }
.ef51 { color: #00ffff; } .eb51 { background-color: #00ffff; }
.ef52 { color: #5f0000; } .eb52 { background-color: #5f0000; }
.ef53 { color: #5f005f; } .eb53 { background-color: #5f005f; }
.ef54 { color: #5f0087; } .eb54 { background-color: #5f0087; }
.ef55 { color: #5f00af; } .eb55 { background-color: #5f00af; }
.ef56 { color: #5f00d7; } .eb56 { background-color: #5f00d7; }
.ef57 { color: #5f00ff; } .eb57 { background-color: #5f00ff; }
.ef58 { color: #5f5f00; } .eb58 { background-color: #5f5f00; }
.ef59 { color: #5f5f5f; } .eb59 { background-color: #5f5f5f; }
.ef60 { color: #5f5f87; } .eb60 { background-color: #5f5f87; }
.ef61 { color: #5f5faf; } .eb61 { background-color: #5f5faf; }
.ef62 { color: #5f5fd7; } .eb62 { background-color: #5f5fd7; }
.ef63 { color: #5f5fff; } .eb63 { background-color: #5f5fff; }
.ef64 { color: #5f8700; } .eb64 { background-color: #5f8700; }
.ef65 { color: #5f875f; } .eb65 { background-color: #5f875f; }
.ef66 { color: #5f8787; } .eb66 { background-color: #5f8787; }
.ef67 { color: #5f87af; } .eb67 { background-color: #5f87af; }
.ef68 { color: #5f87d7; } .eb68 { background-color: #5f87d7; }
.ef69 { color: #5f87ff; } .eb69 { background-color: #5f87ff; }
.ef70 { color: #5faf00; } .eb70 { background-color: #5faf00; }
.ef71 { color: #5faf5f; } .eb71 { background-color: #5faf5f; }
.ef72 { color: #5faf87; } .eb72 { background-color: #5faf87; }
.ef73 { color: #5fafaf; } .eb73 { background-color: #5fafaf; }
.ef74 { color: #5fafd7; } .eb74 { background-color: #5fafd7; }
.ef75 { color: #5fafff; } .eb75 { background-color: #5fafff; }
.ef76 { color: #5fd700; } .eb76 { background-color: #5fd700; }
.ef77 { color: #5fd75f; } .eb77 { background-color: #5fd75f; }
.ef78 { color: #5fd787; } .eb78 { background-color: #5fd787; }
.ef79 { color: #5fd7af; } .eb79 { background-color: #5fd7af; }
.ef80 { color: #5fd7d7; } .eb80 { background-color: #5fd7d7; }
.ef81 { color: #5fd7ff; } .eb81 { background-color: #5fd7ff; }
.ef82 { color: #5fff00; } .eb82 { background-color: #5fff00; }
.ef83 { color: #5fff5f; } .eb83 { background-color: #5fff5f; }
.ef84 { color: #5fff87; } .eb84 { background-color: #5fff87; }
.ef85 { color: #5fffaf; } .eb85 { background-color: #5fffaf; }
.ef86 { color: #5fffd7; } .eb86 { background-color: #5fffd7; }
.ef87 { color: #5fffff; } .eb87 { background-color: #5fffff; }
.ef88 { color: #870000; } .eb88 { background-color: #870000; }
.ef89 { color: #87005f; } .eb89 { background-color: #87005f; }
.ef90 { color: #870087; } .eb90 { background-color: #870087; }
.ef91 { color: #8700af; } .eb91 { background-color: #8700af; }
.ef92 { color: #8700d7; } .eb92 { background-color: #8700d7; }
.ef93 { color: #8700ff; } .eb93 { background-color: #8700ff; }
.ef94 { color: #875f00; } .eb94 { background-color: #875f00; }
.ef95 { color: #875f5f; } .eb95 { background-color: #875f5f; }
.ef96 { color: #875f87; } .eb96 { background-color: #875f87; }
.ef97 { color: #875faf; } .eb97 { background-color: #875faf; }
.ef98 { color: #875fd7; } .eb98 { background-color: #875fd7; }
.ef99 { color: #875fff; } .eb99 { background-color: #875fff; }
.ef100 { color: #878700; } .eb100 { background-color: #878700; }
.ef101 { color: #87875f; } .eb101 { background-color: #87875f; }
.ef102 { color: #878787; } .eb102 { background-color: #878787; }
.ef103 { color: #8787af; } .eb103 { background-color: #8787af; }
.ef104 { color: #8787d7; } .eb104 { background-color: #8787d7; }
.ef105 { color: #8787ff; } .eb105 { background-color: #8787ff; }
.ef106 { color: #87af00; } .eb106 { background-color: #87af00; }
.ef107 { color: #87af5f; } .eb107 { background-color: #87af5f; }
.ef108 { color: #87af87; } .eb108 { background-color: #87af87; }
.ef109 { color: #87afaf; } .eb109 { background-color: #87afaf; }
.ef110 { color: #87afd7; } .eb110 { background-color: #87afd7; }
.ef111 { color: #87afff; } .eb111 { background-color: #87afff; }
.ef112 { color: #87d700; } .eb112 { background-color: #87d700; }
.ef113 { color: #87d75f; } .eb113 { background-color: #87d75f; }
.ef114 { color: #87d787; } .eb114 { background-color: #87d787; }
.ef115 { color: #87d7af; } .eb115 { background-color: #87d7af; }
.ef116 { color: #87d7d7; } .eb116 { background-color: #87d7d7; }
.ef117 { color: #87d7ff; } .eb117 { background-color: #87d7ff; }
.ef118 { color: #87ff00; } .eb118 { background-color: #87ff00; }
.ef119 { color: #87ff5f; } .eb119 { background-color: #87ff5f; }
.ef120 { color: #87ff87; } .eb120 { background-color: #87ff87; }
.ef121 { color: #87ffaf; } .eb121 { background-color: #87ffaf; }
.ef122 { color: #87ffd7; } .eb122 { background-color: #87ffd7; }
.ef123 { color: #87ffff; } .eb123 { background-color: #87ffff; }
.ef124 { color: #af0000; } .eb124 { background-color: #af0000; }
.ef125 { color: #af005f; } .eb125 { background-color: #af005f; }
.ef126 { color: #af0087; } .eb126 { background-color: #af0087; }
.ef127 { color: #af00af; } .eb127 { background-color: #af00af; }
.ef128 { color: #af00d7; } .eb128 { background-color: #af00d7; }
.ef129 { color: #af00ff; } .eb129 { background-color: #af00ff; }
.ef130 { color: #af5f00; } .eb130 { background-color: #af5f00; }
.ef131 { color: #af5f5f; } .eb131 { background-color: #af5f5f; }
.ef132 { color: #af5f87; } .eb132 { background-color: #af5f87; }
.ef133 { color: #af5faf; } .eb133 { background-color: #af5faf; }
.ef134 { color: #af5fd7; } .eb134 { background-color: #af5fd7; }
.ef135 { color: #af5fff; } .eb135 { background-color: #af5fff; }
.ef136 { color: #af8700; } .eb136 { background-color: #af8700; }
.ef137 { color: #af875f; } .eb137 { background-color: #af875f; }
.ef138 { color: #af8787; } .eb138 { background-color: #af8787; }
.ef139 { color: #af87af; } .eb139 { background-color: #af87af; }
.ef140 { color: #af87d7; } .eb140 { background-color: #af87d7; }
.ef141 { color: #af87ff; } .eb141 { background-color: #af87ff; }
.ef142 { color: #afaf00; } .eb142 { background-color: #afaf00; }
.ef143 { color: #afaf5f; } .eb143 { background-color: #afaf5f; }
.ef144 { color: #afaf87; } .eb144 { background-color: #afaf87; }
.ef145 { color: #afafaf; } .eb145 { background-color: #afafaf; }
.ef146 { color: #afafd7; } .eb146 { background-color: #afafd7; }
.ef147 { color: #afafff; } .eb147 { background-color: #afafff; }
.ef148 { color: #afd700; } .eb148 { background-color: #afd700; }
.ef149 { color: #afd75f; } .eb149 { background-color: #afd75f; }
.ef150 { color: #afd787; } .eb150 { background-color: #afd787; }
.ef151 { color: #afd7af; } .eb151 { background-color: #afd7af; }
.ef152 { color: #afd7d7; } .eb152 { background-color: #afd7d7; }
.ef153 { color: #afd7ff; } .eb153 { background-color: #afd7ff; }
.ef154 { color: #afff00; } .eb154 { background-color: #afff00; }
.ef155 { color: #afff5f; } .eb155 { background-color: #afff5f; }
.ef156 { color: #afff87; } .eb156 { background-color: #afff87; }
.ef157 { color: #afffaf; } .eb157 { background-color: #afffaf; }
.ef158 { color: #afffd7; } .eb158 { background-color: #afffd7; }
.ef159 { color: #afffff; } .eb159 { background-color: #afffff; }
.ef160 { color: #d70000; } .eb160 { background-color: #d70000; }
.ef161 { color: #d7005f; } .eb161 { background-color: #d7005f; }
.ef162 { color: #d70087; } .eb162 { background-color: #d70087; }
.ef163 { color: #d700af; } .eb163 { background-color: #d700af; }
.ef164 { color: #d700d7; } .eb164 { background-color: #d700d7; }
.ef165 { color: #d700ff; } .eb165 { background-color: #d700ff; }
.ef166 { color: #d75f00; } .eb166 { background-color: #d75f00; }
.ef167 { color: #d75f5f; } .eb167 { background-color: #d75f5f; }
.ef168 { color: #d75f87; } .eb168 { background-color: #d75f87; }
.ef169 { color: #d75faf; } .eb169 { background-color: #d75faf; }
.ef170 { color: #d75fd7; } .eb170 { background-color: #d75fd7; }
.ef171 { color: #d75fff; } .eb171 { background-color: #d75fff; }
.ef172 { color: #d78700; } .eb172 { background-color: #d78700; }
.ef173 { color: #d7875f; } .eb173 { background-color: #d7875f; }
.ef174 { color: #d78787; } .eb174 { background-color: #d78787; }
.ef175 { color: #d787af; } .eb175 { background-color: #d787af; }
.ef176 { color: #d787d7; } .eb176 { background-color: #d787d7; }
.ef177 { color: #d787ff; } .eb177 { background-color: #d787ff; }
.ef178 { color: #d7af00; } .eb178 { background-color: #d7af00; }
.ef179 { color: #d7af5f; } .eb179 { background-color: #d7af5f; }
.ef180 { color: #d7af87; } .eb180 { background-color: #d7af87; }
.ef181 { color: #d7afaf; } .eb181 { background-color: #d7afaf; }
.ef182 { color: #d7afd7; } .eb182 { background-color: #d7afd7; }
.ef183 { color: #d7afff; } .eb183 { background-color: #d7afff; }
.ef184 { color: #d7d700; } .eb184 { background-color: #d7d700; }
.ef185 { color: #d7d75f; } .eb185 { background-color: #d7d75f; }
.ef186 { color: #d7d787; } .eb186 { background-color: #d7d787; }
.ef187 { color: #d7d7af; } .eb187 { background-color: #d7d7af; }
.ef188 { color: #d7d7d7; } .eb188 { background-color: #d7d7d7; }
.ef189 { color: #d7d7ff; } .eb189 { background-color: #d7d7ff; }
.ef190 { color: #d7ff00; } .eb190 { background-color: #d7ff00; }
.ef191 { color: #d7ff5f; } .eb191 { background-color: #d7ff5f; }
.ef192 { color: #d7ff87; } .eb192 { background-color: #d7ff87; }
.ef193 { color: #d7ffaf; } .eb193 { background-color: #d7ffaf; }
.ef194 { color: #d7ffd7; } .eb194 { background-color: #d7ffd7; }
.ef195 { color: #d7ffff; } .eb195 { background-color: #d7ffff; }
.ef196 { color: #ff0000; } .eb196 { background-color: #ff0000; }
.ef197 { color: #ff005f; } .eb197 { background-color: #ff005f; }
.ef198 { color: #ff0087; } .eb198 { background-color: #ff0087; }
.ef199 { color: #ff00af; } .eb199 { background-color: #ff00af; }
.ef200 { color: #ff00d7; } .eb200 { background-color: #ff00d7; }
.ef201 { color: #ff00ff; } .eb201 { background-color: #ff00ff; }
.ef202 { color: #ff5f00; } .eb202 { background-color: #ff5f00; }
.ef203 { color: #ff5f5f; } .eb203 { background-color: #ff5f5f; }
.ef204 { color: #ff5f87; } .eb204 { background-color: #ff5f87; }
.ef205 { color: #ff5faf; } .eb205 { background-color: #ff5faf; }
.ef206 { color: #ff5fd7; } .eb206 { background-color: #ff5fd7; }
.ef207 { color: #ff5fff; } .eb207 { background-color: #ff5fff; }
.ef208 { color: #ff8700; } .eb208 { background-color: #ff8700; }
.ef209 { color: #ff875f; } .eb209 { background-color: #ff875f; }
.ef210 { color: #ff8787; } .eb210 { background-color: #ff8787; }
.ef211 { color: #ff87af; } .eb211 { background-color: #ff87af; }
.ef212 { color: #ff87d7; } .eb212 { background-color: #ff87d7; }
.ef213 { color: #ff87ff; } .eb213 { background-color: #ff87ff; }
.ef214 { color: #ffaf00; } .eb214 { background-color: #ffaf00; }
.ef215 { color: #ffaf5f; } .eb215 { background-color: #ffaf5f; }
.ef216 { color: #ffaf87; } .eb216 { background-color: #ffaf87; }
.ef217 { color: #ffafaf; } .eb217 { background-color: #ffafaf; }
.ef218 { color: #ffafd7; } .eb218 { background-color: #ffafd7; }
.ef219 { color: #ffafff; } .eb219 { background-color: #ffafff; }
.ef220 { color: #ffd700; } .eb220 { background-color: #ffd700; }
.ef221 { color: #ffd75f; } .eb221 { background-color: #ffd75f; }
.ef222 { color: #ffd787; } .eb222 { background-color: #ffd787; }
.ef223 { color: #ffd7af; } .eb223 { background-color: #ffd7af; }
.ef224 { color: #ffd7d7; } .eb224 { background-color: #ffd7d7; }
.ef225 { color: #ffd7ff; } .eb225 { background-color: #ffd7ff; }
.ef226 { color: #ffff00; } .eb226 { background-color: #ffff00; }
.ef227 { color: #ffff5f; } .eb227 { background-color: #ffff5f; }
.ef228 { color: #ffff87; } .eb228 { background-color: #ffff87; }
.ef229 { color: #ffffaf; } .eb229 { background-color: #ffffaf; }
.ef230 { color: #ffffd7; } .eb230 { background-color: #ffffd7; }
.ef231 { color: #ffffff; } .eb231 { background-color: #ffffff; }
.ef232 { color: #080808; } .eb232 { background-color: #080808; }
.ef233 { color: #121212; } .eb233 { background-color: #121212; }
.ef234 { color: #1c1c1c; } .eb234 { background-color: #1c1c1c; }
.ef235 { color: #262626; } .eb235 { background-color: #262626; }
.ef236 { color: #303030; } .eb236 { background-color: #303030; }
.ef237 { color: #3a3a3a; } .eb237 { background-color: #3a3a3a; }
.ef238 { color: #444444; } .eb238 { background-color: #444444; }
.ef239 { color: #4e4e4e; } .eb239 { background-color: #4e4e4e; }
.ef240 { color: #585858; } .eb240 { background-color: #585858; }
.ef241 { color: #626262; } .eb241 { background-color: #626262; }
.ef242 { color: #6c6c6c; } .eb242 { background-color: #6c6c6c; }
.ef243 { color: #767676; } .eb243 { background-color: #767676; }
.ef244 { color: #808080; } .eb244 { background-color: #808080; }
.ef245 { color: #8a8a8a; } .eb245 { background-color: #8a8a8a; }
.ef246 { color: #949494; } .eb246 { background-color: #949494; }
.ef247 { color: #9e9e9e; } .eb247 { background-color: #9e9e9e; }
.ef248 { color: #a8a8a8; } .eb248 { background-color: #a8a8a8; }
.ef249 { color: #b2b2b2; } .eb249 { background-color: #b2b2b2; }
.ef250 { color: #bcbcbc; } .eb250 { background-color: #bcbcbc; }
.ef251 { color: #c6c6c6; } .eb251 { background-color: #c6c6c6; }
.ef252 { color: #d0d0d0; } .eb252 { background-color: #d0d0d0; }
.ef253 { color: #dadada; } .eb253 { background-color: #dadada; }
.ef254 { color: #e4e4e4; } .eb254 { background-color: #e4e4e4; }
.ef255 { color: #eeeeee; } .eb255 { background-color: #eeeeee; }

.f9 { color: #000000; }
.b9 { background-color: #FFFFFF; }
.f9 > .bold,.bold > .f9, body.f9 > pre > .bold {
  /* Bold is heavy black on white, or bright white
     depending on the default background */
  color: #5555FF;
  font-weight: bold;
}
.reverse {
  /* CSS does not support swapping fg and bg colours unfortunately,
     so just hardcode something that will look OK on all backgrounds. */
  color: #000000; background-color: #AAAAAA;
}
.underline { text-decoration: underline; }
.line-through { text-decoration: line-through; }
.blink { text-decoration: blink; }

/* Avoid pixels between adjacent span elements.
   Note this only works for lines less than 80 chars
   where we close span elements on the same line.
span { display: inline-block; }
*/
</style>
</head>

<body class="f9 b9">
  <h1>说明：</h1>
  <ul>
  	<li>
  		<p>
  			本Demo使用的是
  			<a href="http://www.easemob.com/download">版本号为3.1.4环信官方Demo</a>
  		</p>
  	</li>
  	<li>
  		<p>
  			本Demo在环信官方Demo的基础上集成了BQMM,在修改的地方我们都加上了“BQMM集成"的注释，可在项目中全局搜索查看
  		</p>
  	</li>
  	<li>
  		<p>
  			我们提供了集成之后的Demo与官方Demo的Diff文档,供大家查看 (绿色为新增的代码，红色为删除的代码)
  		</p>
  	</li>
  </ul>


  <h1>
  	集成之后的Demo与官方Demo的Diff文档：
  </h1>
<pre>
<span class="bold">diff --git a/ChatDemo-UI3.0/ChatDemo-UI3.0/Class/AppDelegate.m b/ChatDemo-UI3.0/ChatDemo-UI3.0/Class/AppDelegate.m
index 51ba488..5b8ff4d 100755</span>
<span class="bold">--- a/ChatDemo-UI3.0/ChatDemo-UI3.0/Class/AppDelegate.m</span>
<span class="bold">+++ b/ChatDemo-UI3.0/ChatDemo-UI3.0/Class/AppDelegate.m</span>
<span class="f6">@@ -22,6 +22,11 @@</span>
#import &quot;RedpacketOpenConst.h&quot;


<span class="f2">//BQMM集成</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>

<span class="f2">#import &lt;Bugly/Bugly.h&gt;</span>

@interface AppDelegate ()

@end
<span class="f6">@@ -58,6 +63,14 @@</span> - (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(
    // 环信UIdemo中有用到Parse，您的项目中不需要添加，可忽略此处。
    [self parseApplication:application didFinishLaunchingWithOptions:launchOptions];

    <span class="f2">//BQMM集成</span>
<span class="f2">    // 初始化表情MMSDK</span>
<span class="f2">    [[MMEmotionCentre defaultCentre] setAppId:@&quot;yourid&quot;</span>
<span class="f2">                                       secret:@&quot;yourSecret&quot;];</span>
<span class="f2">    </span>
<span class="f2">    //初始化bugly</span>
<span class="f2">    [Bugly startWithAppId:@&quot;900019325&quot;];</span>

#warning 初始化环信SDK，详细内容在AppDelegate+EaseMob.m 文件中
#warning SDK注册 APNS文件的名字, 需要与后台上传证书时的名字一一对应
    NSString *apnsCertName = nil;
<span class="bold">diff --git a/ChatDemo-UI3.0/ChatDemo-UI3.0/Class/Chat/ChatView/ChatViewController.m b/ChatDemo-UI3.0/ChatDemo-UI3.0/Class/Chat/ChatView/ChatViewController.m
index 083fe7f..a5cd293 100644</span>
<span class="bold">--- a/ChatDemo-UI3.0/ChatDemo-UI3.0/Class/Chat/ChatView/ChatViewController.m</span>
<span class="bold">+++ b/ChatDemo-UI3.0/ChatDemo-UI3.0/Class/Chat/ChatView/ChatViewController.m</span>
<span class="f6">@@ -21,6 +21,9 @@</span>
#import &quot;EMChooseViewController.h&quot;
#import &quot;ContactSelectionViewController.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &quot;MMTextParser+ExtData.h&quot;</span>

@interface ChatViewController ()&lt;UIAlertViewDelegate,EMClientDelegate, EMChooseViewDelegate&gt;
{
    UIMenuItem *_copyMenuItem;
<span class="f6">@@ -291,6 +294,8 @@</span> - (BOOL)isEmotionMessageFormessageViewController:(EaseMessageViewController *)vi
    BOOL flag = NO;
    if ([messageModel.message.ext objectForKey:MESSAGE_ATTR_IS_BIG_EXPRESSION]) {
        return YES;
    <span class="f2">}else if(messageModel.mmExt != nil) {//BQMM集成</span>
<span class="f2">        return YES;</span>
    }
    return flag;
}
<span class="f6">@@ -401,12 +406,20 @@</span> - (void)transpondMenuAction:(id)sender
    self.menuIndexPath = nil;
}

<span class="f2">//BQMM集成</span>
- (void)copyMenuAction:(id)sender
{
    UIPasteboard *pasteboard = [UIPasteboard generalPasteboard];
    if (self.menuIndexPath &amp;&amp; self.menuIndexPath.row &gt; 0) {
        id&lt;IMessageModel&gt; model = [self.dataArray objectAtIndex:self.menuIndexPath.row];
        <span class="f2">if ([model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;emojitype&quot;]) {</span>
<span class="f2">            </span>
<span class="f2">            pasteboard.string = [MMTextParser stringWithExtData:model.mmExt[@&quot;msg_data&quot;]];</span>
<span class="f2">        }</span>
<span class="f2">        else {</span>
            pasteboard.string = model.text;
        <span class="f2">}</span>

    }

    self.menuIndexPath = nil;
<span class="bold">diff --git a/ChatDemo-UI3.0/ChatDemo-UI3.0/Class/Contacts/ContactListSelectViewController.m b/ChatDemo-UI3.0/ChatDemo-UI3.0/Class/Contacts/ContactListSelectViewController.m
index 1b18086..1c2fafa 100644</span>
<span class="bold">--- a/ChatDemo-UI3.0/ChatDemo-UI3.0/Class/Contacts/ContactListSelectViewController.m</span>
<span class="bold">+++ b/ChatDemo-UI3.0/ChatDemo-UI3.0/Class/Contacts/ContactListSelectViewController.m</span>
<span class="f6">@@ -45,6 +45,12 @@</span> - (void)userListViewController:(EaseUsersListViewController *)userListViewContro
    BOOL flag = YES;
    if (self.messageModel) {
        if (self.messageModel.bodyType == EMMessageBodyTypeText) {
            <span class="f2">//BQMM集成</span>
<span class="f2">            NSDictionary *ext = nil;</span>
<span class="f2">            if (self.messageModel.mmExt[@&quot;txt_msgType&quot;]) {</span>
<span class="f2">                ext = self.messageModel.mmExt;</span>
<span class="f2">            }</span>

            EMMessage *message = [EaseSDKHelper sendTextMessage:self.messageModel.text to:userModel.buddy messageType:EMChatTypeChat messageExt:self.messageModel.message.ext];
            __weak typeof(self) weakself = self;
            [[EMClient sharedClient].chatManager asyncSendMessage:message progress:nil completion:^(EMMessage *aMessage, EMError *aError) {
<span class="bold">diff --git a/EaseUI/EMUIKit/Model/EaseMessageModel.h b/EaseUI/EMUIKit/Model/EaseMessageModel.h</span>
<span class="bold">index 0b4099f..be0a6fa 100644</span>
<span class="bold">--- a/EaseUI/EMUIKit/Model/EaseMessageModel.h</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Model/EaseMessageModel.h</span>
<span class="f6">@@ -56,6 +56,11 @@</span>
@property (strong, nonatomic) NSString *fileURLPath;
@property (strong, nonatomic) NSString *thumbnailFileURLPath;


<span class="f2">//BQMM集成</span>
<span class="f2">@property (strong, nonatomic) NSDictionary *mmExt;</span>


- (instancetype)initWithMessage:(EMMessage *)message;

@end
<span class="bold">diff --git a/EaseUI/EMUIKit/Model/EaseMessageModel.m b/EaseUI/EMUIKit/Model/EaseMessageModel.m</span>
<span class="bold">index dcf67f4..0b6df05 100644</span>
<span class="bold">--- a/EaseUI/EMUIKit/Model/EaseMessageModel.m</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Model/EaseMessageModel.m</span>
<span class="f6">@@ -118,6 +118,11 @@</span> - (instancetype)initWithMessage:(EMMessage *)message
            default:
                break;
        }

        <span class="f2">//BQMM集成</span>
<span class="f2">        NSDictionary *ext = message.ext;</span>
<span class="f2">        self.mmExt = ext;</span>

    }

    return self;
<span class="bold">diff --git a/EaseUI/EMUIKit/Model/IMessageModel.h b/EaseUI/EMUIKit/Model/IMessageModel.h</span>
<span class="bold">index f933e43..c1ff4ca 100644</span>
<span class="bold">--- a/EaseUI/EMUIKit/Model/IMessageModel.h</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Model/IMessageModel.h</span>
<span class="f6">@@ -53,6 +53,9 @@</span>
@property (strong, nonatomic) NSString *fileURLPath;
@property (strong, nonatomic) NSString *thumbnailFileURLPath;

<span class="f2">//BQMM集成</span>
<span class="f2">@property (strong, nonatomic) NSDictionary *mmExt;</span>

- (instancetype)initWithMessage:(EMMessage *)message;

@end
<span class="bold">diff --git a/EaseUI/EMUIKit/Util/EaseConvertToCommonEmoticonsHelper.m b/EaseUI/EMUIKit/Util/EaseConvertToCommonEmoticonsHelper.m</span>
<span class="bold">index 8870b0a..c9c5b53 100644</span>
<span class="bold">--- a/EaseUI/EMUIKit/Util/EaseConvertToCommonEmoticonsHelper.m</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Util/EaseConvertToCommonEmoticonsHelper.m</span>
<span class="f6">@@ -17,528 +17,531 @@</span> @implementation EaseConvertToCommonEmoticonsHelper

#pragma mark - emotics

<span class="f2">//BQMM集成   去除环信本身表情映射</span>
+ (NSString *)convertToCommonEmoticons:(NSString *)text
{
    <span class="f2">return text;</span>
<span class="f2">//</span>    int allEmoticsCount = (int)[EaseEmoji allEmoji].count;
<span class="f2">//</span>    NSMutableString *retText = [[NSMutableString alloc] initWithString:text];
<span class="f2">//</span>    for(int i=0; i&lt;allEmoticsCount; ++i) {
<span class="f2">//</span>        NSRange range;
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😊&quot;
<span class="f2">//</span>                                 withString:@&quot;[):]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😃&quot;
<span class="f2">//</span>                                 withString:@&quot;[:D]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😉&quot;
<span class="f2">//</span>                                 withString:@&quot;[;)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😮&quot;
<span class="f2">//</span>                                 withString:@&quot;[:-o]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😋&quot;
<span class="f2">//</span>                                 withString:@&quot;[:p]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😎&quot;
<span class="f2">//</span>                                 withString:@&quot;[(H)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😡&quot;
<span class="f2">//</span>                                 withString:@&quot;[:@]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😖&quot;
<span class="f2">//</span>                                 withString:@&quot;[:s]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😳&quot;
<span class="f2">//</span>                                 withString:@&quot;[:$]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😞&quot;
<span class="f2">//</span>                                 withString:@&quot;[:(]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😭&quot;
<span class="f2">//</span>                                 withString:@&quot;[:'(]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😐&quot;
<span class="f2">//</span>                                 withString:@&quot;[:|]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😇&quot;
<span class="f2">//</span>                                 withString:@&quot;[(a)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😬&quot;
<span class="f2">//</span>                                 withString:@&quot;[8o|]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😆&quot;
<span class="f2">//</span>                                 withString:@&quot;[8-|]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😱&quot;
<span class="f2">//</span>                                 withString:@&quot;[+o(]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;🎅&quot;
<span class="f2">//</span>                                 withString:@&quot;[&lt;o)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😴&quot;
<span class="f2">//</span>                                 withString:@&quot;[|-)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😕&quot;
<span class="f2">//</span>                                 withString:@&quot;[*-)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😷&quot;
<span class="f2">//</span>                                 withString:@&quot;[:-#]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😯&quot;
<span class="f2">//</span>                                 withString:@&quot;[:-*]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😏&quot;
<span class="f2">//</span>                                 withString:@&quot;[^o)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😑&quot;
<span class="f2">//</span>                                 withString:@&quot;[8-)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;💖&quot;
<span class="f2">//</span>                                 withString:@&quot;[(|)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;💔&quot;
<span class="f2">//</span>                                 withString:@&quot;[(u)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;🌙&quot;
<span class="f2">//</span>                                 withString:@&quot;[(S)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;🌟&quot;
<span class="f2">//</span>                                 withString:@&quot;[(*)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;🌞&quot;
<span class="f2">//</span>                                 withString:@&quot;[(#)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;🌈&quot;
<span class="f2">//</span>                                 withString:@&quot;[(R)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//        </span>
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😚&quot;
<span class="f2">//</span>                                 withString:@&quot;[(})]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//        </span>
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;😍&quot;
<span class="f2">//</span>                                 withString:@&quot;[({)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//</span>
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;💋&quot;
<span class="f2">//</span>                                 withString:@&quot;[(k)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;🌹&quot;
<span class="f2">//</span>                                 withString:@&quot;[(F)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;🍂&quot;
<span class="f2">//</span>                                 withString:@&quot;[(W)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;👍&quot;
<span class="f2">//</span>                                 withString:@&quot;[(D)]&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//</span>    }
<span class="f2">//    </span>
<span class="f2">//</span>    return retText;
}

+ (NSString *)convertToSystemEmoticons:(NSString *)text
{
    <span class="f2">return text;</span>
<span class="f2">//</span>    if (![text isKindOfClass:[NSString class]]) {
<span class="f2">//</span>        return @&quot;&quot;;
<span class="f2">//</span>    }
<span class="f2">//    </span>
<span class="f2">//</span>    if ([text length] == 0) {
<span class="f2">//</span>        return @&quot;&quot;;
<span class="f2">//</span>    }
<span class="f2">//</span>    int allEmoticsCount = (int)[[EaseEmoji allEmoji] count];
<span class="f2">//</span>    NSMutableString *retText = [[NSMutableString alloc] initWithString:text];
<span class="f2">//</span>    for(int i=0; i&lt;allEmoticsCount; ++i) {
<span class="f2">//</span>        NSRange range;
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[):]&quot;
<span class="f2">//</span>                                 withString:@&quot;😊&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[:D]&quot;
<span class="f2">//</span>                                 withString:@&quot;😃&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[;)]&quot;
<span class="f2">//</span>                                 withString:@&quot;😉&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[:-o]&quot;
<span class="f2">//</span>                                 withString:@&quot;😮&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[:p]&quot;
<span class="f2">//</span>                                 withString:@&quot;😋&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[(H)]&quot;
<span class="f2">//</span>                                 withString:@&quot;😎&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[:@]&quot;
<span class="f2">//</span>                                 withString:@&quot;😡&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[:s]&quot;
<span class="f2">//</span>                                 withString:@&quot;😖&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[:$]&quot;
<span class="f2">//</span>                                 withString:@&quot;😳&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[:(]&quot;
<span class="f2">//</span>                                 withString:@&quot;😞&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[:'(]&quot;
<span class="f2">//</span>                                 withString:@&quot;😭&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[:|]&quot;
<span class="f2">//</span>                                 withString:@&quot;😐&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[(a)]&quot;
<span class="f2">//</span>                                 withString:@&quot;😇&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[8o|]&quot;
<span class="f2">//</span>                                 withString:@&quot;😬&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[8-|]&quot;
<span class="f2">//</span>                                 withString:@&quot;😆&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[+o(]&quot;
<span class="f2">//</span>                                 withString:@&quot;😱&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[&lt;o)]&quot;
<span class="f2">//</span>                                 withString:@&quot;🎅&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[|-)]&quot;
<span class="f2">//</span>                                 withString:@&quot;😴&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[*-)]&quot;
<span class="f2">//</span>                                 withString:@&quot;😕&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[:-#]&quot;
<span class="f2">//</span>                                 withString:@&quot;😷&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[:-*]&quot;
<span class="f2">//</span>                                 withString:@&quot;😯&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[^o)]&quot;
<span class="f2">//</span>                                 withString:@&quot;😏&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[8-)]&quot;
<span class="f2">//</span>                                 withString:@&quot;😑&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[(|)]&quot;
<span class="f2">//</span>                                 withString:@&quot;💖&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[(u)]&quot;
<span class="f2">//</span>                                 withString:@&quot;💔&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[(S)]&quot;
<span class="f2">//</span>                                 withString:@&quot;🌙&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[(*)]&quot;
<span class="f2">//</span>                                 withString:@&quot;🌟&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[(#)]&quot;
<span class="f2">//</span>                                 withString:@&quot;🌞&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[(R)]&quot;
<span class="f2">//</span>                                 withString:@&quot;🌈&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//        </span>
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[(})]&quot;
<span class="f2">//</span>                                 withString:@&quot;😚&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//        </span>
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[({)]&quot;
<span class="f2">//</span>                                 withString:@&quot;😍&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//</span>
<span class="f2">//        </span>
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[(k)]&quot;
<span class="f2">//</span>                                 withString:@&quot;💋&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[(F)]&quot;
<span class="f2">//</span>                                 withString:@&quot;🌹&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[(W)]&quot;
<span class="f2">//</span>                                 withString:@&quot;🍂&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//        </span>
<span class="f2">//</span>        range.location = 0;
<span class="f2">//</span>        range.length = retText.length;
<span class="f2">//</span>        [retText replaceOccurrencesOfString:@&quot;[(D)]&quot;
<span class="f2">//</span>                                 withString:@&quot;👍&quot;
<span class="f2">//</span>                                    options:NSLiteralSearch
<span class="f2">//</span>                                      range:range];
<span class="f2">//</span>    }
<span class="f2">//    </span>
<span class="f2">//</span>    return retText;
}

@end
<span class="bold">diff --git a/EaseUI/EMUIKit/ViewController/EaseMessageViewController.m b/EaseUI/EMUIKit/ViewController/EaseMessageViewController.m</span>
<span class="bold">index 766c1f4..b7adde4 100644</span>
<span class="bold">--- a/EaseUI/EMUIKit/ViewController/EaseMessageViewController.m</span>
<span class="bold">+++ b/EaseUI/EMUIKit/ViewController/EaseMessageViewController.m</span>
<span class="f6">@@ -27,6 +27,11 @@</span>
#import &quot;EaseLocalDefine.h&quot;
#import &quot;EaseSDKHelper.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>
<span class="f2">#import &quot;MMTextParser+ExtData.h&quot;</span>


#define KHintAdjustY    50

#define IOS_VERSION [[UIDevice currentDevice] systemVersion]&gt;=9.0
<span class="f6">@@ -180,6 +185,8 @@</span> - (void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];

    <span class="f2">[self.tableView reloadData];</span>

    self.isViewDidAppear = YES;
    [[EaseSDKHelper shareHelper] setIsShowingimagePicker:NO];

<span class="f6">@@ -1097,6 +1104,17 @@</span> - (void)messageCellSelected:(id&lt;IMessageModel&gt;)model
    }

    switch (model.bodyType) {
            <span class="f2">//BQMM集成</span>
<span class="f2">        case EMMessageBodyTypeText:</span>
<span class="f2">        {</span>
<span class="f2">            if ([model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]) {</span>
<span class="f2">                [self.chatToolbar endEditing:YES];</span>
<span class="f2">                UIViewController *emojiController = [[MMEmotionCentre defaultCentre] controllerForEmotionCode:model.mmExt[@&quot;msg_data&quot;][0][0]];</span>
<span class="f2">                [self.navigationController pushViewController:emojiController animated:YES];</span>
<span class="f2">            }</span>
<span class="f2">        }</span>
<span class="f2">            break;</span>

        case EMMessageBodyTypeImage:
        {
            _scrollToBottomWhenAppear = NO;
<span class="f6">@@ -1268,6 +1286,20 @@</span> - (void)didSendText:(NSString *)text withExt:(NSDictionary*)ext
    }
}


<span class="f2">//BQMM集成</span>
<span class="f2">- (void)didSendMMFace:(MMEmoji *)emoji</span>
<span class="f2">{</span>
<span class="f2">    [self sendMMFaceMessage:emoji];</span>
<span class="f2">}</span>

<span class="f2">- (void)didSendMMFace:(MMEmoji *)emoji withExt:(NSDictionary*)ext</span>
<span class="f2">{</span>
<span class="f2">    [self sendMMFaceMessage:emoji withExt:ext];</span>
<span class="f2">}</span>



- (void)didStartRecordingVoiceAction:(UIView *)recordView
{
    if ([self.delegate respondsToSelector:@selector(messageViewController:didSelectRecordView:withEvenType:)]) {
<span class="f6">@@ -1560,10 +1592,16 @@</span> - (void)proximitySensorChanged:(BOOL)isCloseToUser

- (void)copyMenuAction:(id)sender
{
    <span class="f2">//BQMM集成</span>
    UIPasteboard *pasteboard = [UIPasteboard generalPasteboard];
    if (self.menuIndexPath &amp;&amp; self.menuIndexPath.row &gt; 0) {
        id&lt;IMessageModel&gt; model = [self.dataArray objectAtIndex:self.menuIndexPath.row];
        <span class="f2">if ([model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;emojitype&quot;]) {</span>
<span class="f2">            pasteboard.string = [MMTextParser stringWithExtData:model.mmExt[@&quot;msg_data&quot;]];</span>
<span class="f2">        }</span>
<span class="f2">        else {</span>
            pasteboard.string = model.text;
        <span class="f2">}</span>
    }

    self.menuIndexPath = nil;
<span class="f6">@@ -1737,9 +1775,10 @@</span> - (void)_sendMessage:(EMMessage *)message
    }];
}

<span class="f2">//BQMM集成</span>
- (void)sendTextMessage:(NSString *)text
{
    <span class="f1">NSDictionary</span><span class="f2">NSMutableDictionary</span> *ext = nil;
    if (self.conversation.type == EMConversationTypeGroupChat) {
        NSArray *targets = [self _searchAtTargets:text];
        if ([targets count]) {
<span class="f6">@@ -1751,14 +1790,34 @@</span> - (void)sendTextMessage:(NSString *)text
                }
            }];
            if (atAll) {
                ext<span class="f1">= @{</span><span class="f2">[</span>kGroupMessageAtList<span class="f1">:</span><span class="f2">] =</span> kGroupMessageAtAll<span class="f1">}</span>;
            }
            else {
                ext<span class="f1">= @{</span><span class="f2">[</span>kGroupMessageAtList<span class="f1">:</span><span class="f2">] =</span> targets<span class="f1">}</span>;
            }
        }
    }

    <span class="f2">NSString *text_ = [text stringByReplacingOccurrencesOfString:@&quot;\a&quot; withString:@&quot;&quot;];</span>
<span class="f2">    [MMTextParser localParseMMText:text_ completionHandler:^(NSArray *textImgArray) {</span>
<span class="f2">        NSDictionary *mmExt = nil;</span>
<span class="f2">        NSString *sendStr = @&quot;&quot;;</span>
<span class="f2">        for (id obj in textImgArray) {</span>
<span class="f2">            if ([obj isKindOfClass:[MMEmoji class]]) {</span>
<span class="f2">                MMEmoji *emoji = (MMEmoji*)obj;</span>
<span class="f2">                if (!mmExt) {</span>
<span class="f2">                    mmExt = @{@&quot;txt_msgType&quot;:@&quot;emojitype&quot;,</span>
<span class="f2">                              @&quot;msg_data&quot;:[MMTextParser extDataWithTextImageArray:textImgArray]};</span>
<span class="f2">                }</span>
<span class="f2">                sendStr = [sendStr stringByAppendingString:[NSString stringWithFormat:@&quot;[%@]&quot;, emoji.emojiName]];</span>
<span class="f2">            }</span>
<span class="f2">            else if ([obj isKindOfClass:[NSString class]]) {</span>
<span class="f2">                sendStr = [sendStr stringByAppendingString:obj];</span>
<span class="f2">            }</span>
<span class="f2">        }</span>
<span class="f2">        [ext addEntriesFromDictionary:mmExt];</span>
        [self sendTextMessage:<span class="f1">text</span><span class="f2">sendStr</span> withExt:ext];
    <span class="f2">}];</span>
}

- (void)sendTextMessage:(NSString *)text withExt:(NSDictionary*)ext
<span class="f6">@@ -1770,6 +1829,25 @@</span> - (void)sendTextMessage:(NSString *)text withExt:(NSDictionary*)ext
    [self _sendMessage:message];
}


<span class="f2">//BQMM集成</span>
<span class="f2">-(void)sendMMFaceMessage:(MMEmoji *)emoji</span>
<span class="f2">{</span>
<span class="f2">    NSDictionary *mmExt = @{@&quot;txt_msgType&quot;:@&quot;facetype&quot;,</span>
<span class="f2">                            @&quot;msg_data&quot;:[MMTextParser extDataWithEmoji:emoji]};</span>
<span class="f2">    [self sendMMFaceMessage:emoji withExt:mmExt];</span>
<span class="f2">}</span>

<span class="f2">-(void)sendMMFaceMessage:(MMEmoji *)emoji withExt:(NSDictionary*)ext</span>
<span class="f2">{</span>
<span class="f2">    EMMessage *message = [EaseSDKHelper sendTextMessage:[NSString stringWithFormat:@&quot;[%@]&quot;, emoji.emojiName]</span>
<span class="f2">                                                     to:self.conversation.conversationId</span>
<span class="f2">                                            messageType:[self _messageTypeFromConversationType]</span>
<span class="f2">                                             messageExt:ext];</span>
<span class="f2">    [self _sendMessage:message];</span>
<span class="f2">}</span>


- (void)sendLocationMessageLatitude:(double)latitude
                          longitude:(double)longitude
                         andAddress:(NSString *)address
<span class="bold">diff --git a/EaseUI/EMUIKit/Views/conversation/MessageCell/EMBubbleView+MMText.h b/EaseUI/EMUIKit/Views/conversation/MessageCell/EMBubbleView+MMText.h</span>
<span class="bold">new file mode 100644</span>
<span class="bold">index 0000000..ba726eb</span>
<span class="bold">--- /dev/null</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Views/conversation/MessageCell/EMBubbleView+MMText.h</span>
<span class="f6">@@ -0,0 +1,22 @@</span>
<span class="f2">//</span>
<span class="f2">//  EMBubbleView+MMText.h</span>
<span class="f2">//  ChatDemo-UI3.0</span>
<span class="f2">//</span>
<span class="f2">//  Created by LiChao Jun on 16/2/4.</span>
<span class="f2">//  Copyright © 2016年 LiChao Jun. All rights reserved.</span>
<span class="f2">//</span>

<span class="f2">//BQMM集成 新添加的文件</span>
<span class="f2">#import &lt;Foundation/Foundation.h&gt;</span>

<span class="f2">@class MMTextView;</span>

<span class="f2">@interface EaseBubbleView (MMText)</span>

<span class="f2">@property(nonatomic, retain) MMTextView *textView;</span>

<span class="f2">- (void)setupMMTextBubbleViewWithModel:(id&lt;IMessageModel&gt;)model;</span>

<span class="f2">- (void)updateMMTextMargin:(UIEdgeInsets)margin;</span>

<span class="f2">@end</span>
<span class="bold">diff --git a/EaseUI/EMUIKit/Views/conversation/MessageCell/EMBubbleView+MMText.m b/EaseUI/EMUIKit/Views/conversation/MessageCell/EMBubbleView+MMText.m</span>
<span class="bold">new file mode 100644</span>
<span class="bold">index 0000000..c55e7e3</span>
<span class="bold">--- /dev/null</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Views/conversation/MessageCell/EMBubbleView+MMText.m</span>
<span class="f6">@@ -0,0 +1,73 @@</span>
<span class="f2">//</span>
<span class="f2">//  EMBubbleView+MMText.m</span>
<span class="f2">//  ChatDemo-UI3.0</span>
<span class="f2">//</span>
<span class="f2">//  Created by LiChao Jun on 16/2/4.</span>
<span class="f2">//  Copyright © 2016年 LiChao Jun. All rights reserved.</span>
<span class="f2">//</span>

<span class="f2">#import &quot;EMBubbleView+MMText.h&quot;</span>
<span class="f2">#import &lt;objc/runtime.h&gt;</span>

<span class="f2">#import &quot;MMTextView.h&quot;</span>

<span class="f2">static const void *textViewKey = &amp;textViewKey;</span>

<span class="f2">@implementation EaseBubbleView (MMText)</span>

<span class="f2">#pragma mark - private</span>

<span class="f2">- (void)_setupMMTextBubbleMarginConstraints</span>
<span class="f2">{</span>
<span class="f2">    NSLayoutConstraint *marginTopConstraint = [NSLayoutConstraint constraintWithItem:self.textView attribute:NSLayoutAttributeTop relatedBy:NSLayoutRelationEqual toItem:self.backgroundImageView attribute:NSLayoutAttributeTop multiplier:1.0 constant:self.margin.top];
    NSLayoutConstraint *marginBottomConstraint = [NSLayoutConstraint constraintWithItem:self.textView attribute:NSLayoutAttributeBottom relatedBy:NSLayoutRelationEqual toItem:self.backgroundImageView attribute:NSLayoutAttributeBottom multiplier:1.0 constant:-self.margin.bottom];
    NSLayoutConstraint *marginLeftConstraint = [NSLayoutConstraint constraintWithItem:self.textView attribute:NSLayoutAttributeRight relatedBy:NSLayoutRelationEqual toItem:self.backgroundImageView attribute:NSLayoutAttributeRight multiplier:1.0 constant:-self.margin.right];</span>
<span class="f2">    NSLayoutConstraint *marginRightConstraint = [NSLayoutConstraint constraintWithItem:self.textView attribute:NSLayoutAttributeLeft relatedBy:NSLayoutRelationEqual toItem:self.backgroundImageView attribute:NSLayoutAttributeLeft multiplier:1.0 constant:self.margin.left];</span>
<span class="f2">    </span>
<span class="f2">    [self.marginConstraints removeAllObjects];</span>
<span class="f2">    [self.marginConstraints addObject:marginTopConstraint];</span>
<span class="f2">    [self.marginConstraints addObject:marginBottomConstraint];</span>
<span class="f2">    [self.marginConstraints addObject:marginLeftConstraint];</span>
<span class="f2">    [self.marginConstraints addObject:marginRightConstraint];</span>
<span class="f2">    </span>
<span class="f2">    [self addConstraints:self.marginConstraints];</span>
<span class="f2">}</span>

<span class="f2">- (void)_setupMMTextBubbleConstraints</span>
<span class="f2">{</span>
<span class="f2">    [self _setupMMTextBubbleMarginConstraints];</span>
<span class="f2">}</span>

<span class="f2">- (NSString *)textView {</span>
<span class="f2">    return objc_getAssociatedObject(self, textViewKey);</span>
<span class="f2">}</span>

<span class="f2">- (void)setTextView:(UITextView *)textView {</span>
<span class="f2">    objc_setAssociatedObject(self, textViewKey, textView, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span>
<span class="f2">}</span>

<span class="f2">#pragma mark - public</span>

<span class="f2">- (void)setupMMTextBubbleViewWithModel:(id&lt;IMessageModel&gt;)model</span>
<span class="f2">{</span>
<span class="f2">    self.textView = [[MMTextView alloc] init];</span>
<span class="f2">    self.textView.mmFont = [UIFont systemFontOfSize:15];</span>
<span class="f2">    self.textView.translatesAutoresizingMaskIntoConstraints = NO;</span>
<span class="f2">    self.textView.backgroundColor = [UIColor clearColor];</span>
<span class="f2">    [self.backgroundImageView addSubview:self.textView];</span>
<span class="f2">    </span>
<span class="f2">    [self _setupMMTextBubbleConstraints];</span>
<span class="f2">}</span>

<span class="f2">- (void)updateMMTextMargin:(UIEdgeInsets)margin</span>
<span class="f2">{</span>
<span class="f2">    if (_margin.top == margin.top &amp;&amp; _margin.bottom == margin.bottom &amp;&amp; _margin.left == margin.left &amp;&amp; _margin.right == margin.right) {</span>
<span class="f2">        return;</span>
<span class="f2">    }</span>
<span class="f2">    _margin = margin;</span>
<span class="f2">    </span>
<span class="f2">    [self removeConstraints:self.marginConstraints];</span>
<span class="f2">    [self _setupMMTextBubbleMarginConstraints];</span>
<span class="f2">}</span>

<span class="f2">@end</span>
<span class="bold">diff --git a/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseBaseMessageCell.m b/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseBaseMessageCell.m</span>
<span class="bold">index ffd78bc..b9e452c 100644</span>
<span class="bold">--- a/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseBaseMessageCell.m</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseBaseMessageCell.m</span>
<span class="f6">@@ -14,6 +14,12 @@</span>

#import &quot;UIImageView+EMWebCache.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &quot;MMTextView.h&quot;</span>

<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>
<span class="f2">#import &quot;MMTextParser+ExtData.h&quot;</span>

@interface EaseBaseMessageCell()

@property (strong, nonatomic) UILabel *nameLabel;
<span class="f6">@@ -83,6 +89,18 @@</span> - (void)layoutSubviews
    switch (self.model.bodyType) {
        case EMMessageBodyTypeText:
        {
            <span class="f2">//BQMM集成</span>
<span class="f2">            if ([self.model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;emojitype&quot;]) {</span>
<span class="f2">                CGFloat bubbleMaxWidth = self.bubbleMaxWidth;</span>
<span class="f2">                if ([UIDevice currentDevice].systemVersion.floatValue == 7.0) {</span>
<span class="f2">                    bubbleMaxWidth = 200;</span>
<span class="f2">                }</span>
<span class="f2">                bubbleMaxWidth -= (self.leftBubbleMargin.left + self.leftBubbleMargin.right + self.rightBubbleMargin.left + self.rightBubbleMargin.right)/2;</span>
<span class="f2">                CGSize size = [MMTextParser sizeForMMTextWithExtData:self.model.mmExt[@&quot;msg_data&quot;] font:self.messageTextFont maximumTextWidth:bubbleMaxWidth];</span>
<span class="f2">                [self setBubbleWidth:size.width + 25];</span>
<span class="f2">                </span>
<span class="f2">            }</span>

        }
            break;
        case EMMessageBodyTypeImage:
<span class="bold">diff --git a/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseCustomMessageCell.m b/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseCustomMessageCell.m</span>
<span class="bold">index f809414..8e99271 100644</span>
<span class="bold">--- a/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseCustomMessageCell.m</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseCustomMessageCell.m</span>
<span class="f6">@@ -16,6 +16,12 @@</span>
#import &quot;UIImage+EMGIF.h&quot;
#import &quot;IMessageModel.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>
<span class="f2">#import &quot;EMBubbleView+MMText.h&quot;</span>
<span class="f2">#import &quot;MMTextView.h&quot;</span>


@interface EaseCustomMessageCell ()

@end
<span class="f6">@@ -28,19 +34,60 @@</span> + (void)initialize
}

#pragma mark - IModelCell
<span class="f2">//BQMM集成</span>
- (BOOL)isCustomBubbleView:(id&lt;IMessageModel&gt;)model
{
    <span class="f1">return</span><span class="f2">BOOL flag = NO;</span>
<span class="f2">    switch (model.bodyType) {</span>
<span class="f2">        case EMMessageBodyTypeText:</span>
<span class="f2">        {</span>
<span class="f2">            if ([model.mmExt objectForKey:@&quot;em_emotion&quot;]) {</span>
<span class="f2">                flag = YES;</span>
<span class="f2">            }</span>
<span class="f2">            else if ([model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;emojitype&quot;]) {</span>
<span class="f2">                flag = YES;</span>
<span class="f2">            }</span>
<span class="f2">            else if ([model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]) {</span>
<span class="f2">                flag =</span> YES;
            <span class="f2">}</span>
<span class="f2">        }</span>
<span class="f2">            break;</span>
<span class="f2">        default:</span>
<span class="f2">            break;</span>
<span class="f2">    }    return flag;</span>

}

<span class="f2">//BQMM集成</span>
- (void)setCustomModel:(id&lt;IMessageModel&gt;)model
{
    <span class="f1">UIImage *image =</span><span class="f2">if ([</span>model.<span class="f1">image</span><span class="f2">mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;emojitype&quot;]) {</span>
<span class="f2">        [_bubbleView.textView setMmTextData:model.mmExt[@&quot;msg_data&quot;]]</span>;
    <span class="f2">}</span>
<span class="f2">    else</span> if (<span class="f1">!image</span><span class="f2">[model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]</span>) {
        <span class="f1">[</span><span class="f2">//大表情显示</span>
        self.bubbleView.imageView<span class="f1">sd_setImageWithURL:</span><span class="f2">.image =</span> [<span class="f1">NSURL URLWithString</span><span class="f2">UIImage imageNamed</span>:<span class="f2">@&quot;mm_emoji_loading&quot;];</span>
<span class="f2">        NSArray *codes = nil;</span>
<span class="f2">        if (</span>model<span class="f1">.fileURLPath</span><span class="f2">.mmExt[@&quot;msg_data&quot;</span>]<span class="f1">placeholderImage:</span><span class="f2">) {</span>
<span class="f2">            codes = @</span>[<span class="f1">UIImage imageNamed:</span>model<span class="f1">.failImageName</span><span class="f2">.mmExt[@&quot;msg_data&quot;][0][0</span>]];
        }
        <span class="f2">//兼容1.0之前（含）版本的消息格式</span>
        else {
            <span class="f1">_bubbleView</span><span class="f2">codes = @[model.text];</span>
<span class="f2">        }</span>
<span class="f2">        __weak typeof(self) weakSelf = self;</span>
<span class="f2">        [[MMEmotionCentre defaultCentre] fetchEmojisByType:MMFetchTypeBig codes:codes completionHandler:^(NSArray *emojis) {</span>
<span class="f2">            if (emojis.count &gt; 0) {</span>
<span class="f2">                MMEmoji *emoji = emojis[0];</span>
<span class="f2">                if ([weakSelf.model.mmExt[@&quot;msg_data&quot;][0][0] isEqualToString:emoji.emojiCode]) {</span>
<span class="f2">                    weakSelf.bubbleView</span>.imageView.image = <span class="f2">emoji.emojiImage;</span>
<span class="f2">                }</span>
<span class="f2">            }</span>
<span class="f2">            else {</span>
<span class="f2">                weakSelf.bubbleView.imageView.</span>image <span class="f2">= [UIImage imageNamed:@&quot;mm_emoji_error&quot;];</span>
<span class="f2">            }</span>
<span class="f2">        }]</span>;

    }

    if (model.avatarURLPath) {
<span class="f6">@@ -50,26 +97,67 @@</span> - (void)setCustomModel:(id&lt;IMessageModel&gt;)model
    }
}

<span class="f2">//BQMM集成</span>
- (void)setCustomBubbleView:(id&lt;IMessageModel&gt;)model
{
    <span class="f2">if ([model.mmExt objectForKey:@&quot;em_emotion&quot;]) {</span>
        [_bubbleView setupGifBubbleView];

        _bubbleView.imageView.image = [UIImage imageNamed:<span class="f2">model.failImageName];</span>
<span class="f2">    }</span>
<span class="f2">    else if ([model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;emojitype&quot;]) {</span>
<span class="f2">        [_bubbleView setupMMTextBubbleViewWithModel:model];</span>
<span class="f2">    }</span>
<span class="f2">    else if ([model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:</span>@&quot;<span class="f1">imageDownloadFail</span><span class="f2">facetype</span>&quot;]<span class="f2">) {</span>
<span class="f2">        [_bubbleView setupGifBubbleView];</span>
<span class="f2">        </span>
<span class="f2">        _bubbleView.imageView.image = [UIImage imageNamed:model.failImageName]</span>;
    <span class="f2">}</span>
}

<span class="f2">//BQMM集成</span>
- (void)updateCustomBubbleViewMargin:(UIEdgeInsets)bubbleMargin model:(id&lt;IMessageModel&gt;)model
{
    <span class="f2">if ([model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;emojitype&quot;]) {</span>
<span class="f2">        [_bubbleView updateMMTextMargin:bubbleMargin];</span>
<span class="f2">    }</span>
<span class="f2">    else if ([model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]) {</span>
        [_bubbleView updateGifMargin:bubbleMargin];
    <span class="f2">}</span>
}

<span class="f2">//BQMM集成</span>
+ (NSString *)cellIdentifierWithModel:(id&lt;IMessageModel&gt;)model
{
    <span class="f2">if ([model.mmExt objectForKey:@&quot;em_emotion&quot;]) {</span>
        return model.isSender?@&quot;EaseMessageCellSendGif&quot;:@&quot;EaseMessageCellRecvGif&quot;;
    <span class="f2">}</span>
<span class="f2">    else if ([model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;emojitype&quot;]) {</span>
<span class="f2">        return model.isSender?@&quot;EaseMessageCellSendMMText&quot;:@&quot;EaseMessageCellRecvMMText&quot;;</span>
<span class="f2">    }</span>
<span class="f2">    else if ([model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]) {</span>
<span class="f2">        return model.isSender?@&quot;EaseMessageCellSendGif&quot;:@&quot;EaseMessageCellRecvGif&quot;;</span>
<span class="f2">    }</span>
<span class="f2">    else {</span>
<span class="f2">        NSString *identifier = [EaseBaseMessageCell cellIdentifierWithModel:model];</span>
<span class="f2">        return identifier;</span>
<span class="f2">    }</span>

}

<span class="f2">//BQMM集成</span>
+ (CGFloat)cellHeightWithModel:(id&lt;IMessageModel&gt;)model
{
    <span class="f2">if ([model.mmExt objectForKey:@&quot;em_emotion&quot;]) {</span>
        return 100;
    <span class="f2">}</span>
<span class="f2">    else if ([model.mmExt[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]) {</span>
<span class="f2">        return kEMMessageImageSizeHeight;</span>
<span class="f2">    }</span>
<span class="f2">    else {</span>
<span class="f2">        CGFloat height = [EaseBaseMessageCell cellHeightWithModel:model];</span>
<span class="f2">        return height;</span>
<span class="f2">    }</span>
}

@end
<span class="bold">diff --git a/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseMessageCell.h b/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseMessageCell.h</span>
<span class="bold">index 8a4520b..51c9932 100644</span>
<span class="bold">--- a/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseMessageCell.h</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseMessageCell.h</span>
<span class="f6">@@ -67,6 +67,10 @@</span> typedef enum{

@property (nonatomic) CGFloat bubbleMaxWidth UI_APPEARANCE_SELECTOR; //default 200;

<span class="f2">//BQMM集成</span>
<span class="f2">@property (nonatomic) CGFloat bubbleWidth UI_APPEARANCE_SELECTOR; //default 200;</span>


@property (nonatomic) UIEdgeInsets bubbleMargin UI_APPEARANCE_SELECTOR; //default UIEdgeInsetsMake(8, 0, 8, 0);

@property (nonatomic) UIEdgeInsets leftBubbleMargin UI_APPEARANCE_SELECTOR; //default UIEdgeInsetsMake(8, 15, 8, 10);
<span class="bold">diff --git a/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseMessageCell.m b/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseMessageCell.m</span>
<span class="bold">index 0376da9..00659d8 100644</span>
<span class="bold">--- a/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseMessageCell.m</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Views/conversation/MessageCell/EaseMessageCell.m</span>
<span class="f6">@@ -22,6 +22,10 @@</span>
#import &quot;EaseEmotionEscape.h&quot;
#import &quot;EaseLocalDefine.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &quot;MMTextView.h&quot;</span>
<span class="f2">#import &quot;MMTextParser+ExtData.h&quot;</span>

CGFloat const EaseMessageCellPadding = 10;

NSString *const EaseMessageCellIdentifierRecvText = @&quot;EaseMessageCellRecvText&quot;;
<span class="f6">@@ -281,6 +285,16 @@</span> - (void)_updateBubbleMaxWidthConstraint
//    self.bubbleMaxWidthConstraint.active = YES;
}

<span class="f2">//BQMM集成</span>
<span class="f2">- (void)_updateBubbleWidthConstraint</span>
<span class="f2">{</span>
<span class="f2">    [self removeConstraint:self.bubbleMaxWidthConstraint];</span>
<span class="f2">    </span>
<span class="f2">    self.bubbleMaxWidthConstraint = [NSLayoutConstraint constraintWithItem:self.bubbleView attribute:NSLayoutAttributeWidth relatedBy:NSLayoutRelationEqual toItem:nil attribute:NSLayoutAttributeNotAnAttribute multiplier:1.0 constant:self.bubbleWidth];</span>
<span class="f2">    [self addConstraint:self.bubbleMaxWidthConstraint];</span>
<span class="f2">}</span>


#pragma mark - setter

- (void)setModel:(id&lt;IMessageModel&gt;)model
<span class="f6">@@ -399,6 +413,13 @@</span> - (void)setBubbleMaxWidth:(CGFloat)bubbleMaxWidth
    [self _updateBubbleMaxWidthConstraint];
}

<span class="f2">//BQMM集成</span>
<span class="f2">- (void)setBubbleWidth:(CGFloat)bubbleWidth</span>
<span class="f2">{</span>
<span class="f2">    _bubbleWidth = bubbleWidth;</span>
<span class="f2">    [self _updateBubbleWidthConstraint];</span>
<span class="f2">}</span>

- (void)setRightBubbleMargin:(UIEdgeInsets)rightBubbleMargin
{
    _rightBubbleMargin = rightBubbleMargin;
<span class="f6">@@ -703,6 +724,7 @@</span> + (NSString *)cellIdentifierWithModel:(id&lt;IMessageModel&gt;)model
    return cellIdentifier;
}

<span class="f2">//BQMM集成</span>
+ (CGFloat)cellHeightWithModel:(id&lt;IMessageModel&gt;)model
{
    if (model.cellHeight &gt; 0) {
<span class="f6">@@ -721,20 +743,17 @@</span> + (CGFloat)cellHeightWithModel:(id&lt;IMessageModel&gt;)model
    switch (model.bodyType) {
        case EMMessageBodyTypeText:
        {
            <span class="f1">NSAttributedString</span><span class="f2">UIFont</span> *<span class="f1">text</span><span class="f2">textFont</span> = <span class="f2">cell.messageTextFont;</span>
<span class="f2">            if (</span>[<span class="f1">[EaseEmotionEscape sharedInstance] attStringFromTextForChatting:</span>model.<span class="f1">text textFont</span><span class="f2">mmExt[@&quot;txt_msgType&quot;] isEqualToString</span>:<span class="f1">cell.messageTextFont</span><span class="f2">@&quot;emojitype&quot;</span>]<span class="f1">;</span>
<span class="f1">            CGRect rect</span><span class="f2">) {</span>
<span class="f2">                CGSize size</span> = [<span class="f1">text boundingRectWithSize</span><span class="f2">MMTextParser sizeForMMTextWithExtData</span>:<span class="f1">CGSizeMake(bubbleMaxWidth, CGFLOAT_MAX) options</span><span class="f2">model.mmExt[@&quot;msg_data&quot;] font</span>:<span class="f1">NSStringDrawingUsesLineFragmentOrigin|NSStringDrawingUsesFontLeading context</span><span class="f2">textFont maximumTextWidth</span>:<span class="f1">nil</span><span class="f2">bubbleMaxWidth</span>];

                height += (<span class="f1">rect.</span>size.height &gt; 20 ?<span class="f1">rect.</span> size.height : 20) + <span class="f1">10</span><span class="f2">4</span>;
            <span class="f1">//</span><span class="f2">}</span>
<span class="f2">            else {</span>
                NSString *text = model.text;
                <span class="f1">//            UIFont *textFont = cell.messageTextFont;</span>
<span class="f1">//            CGSize retSize;</span>
<span class="f1">//            if ([NSString instancesRespondToSelector:@selector(boundingRectWithSize:options:attributes:context:)]) {</span>
<span class="f1">//                retSize</span><span class="f2">CGRect rect</span> = [text boundingRectWithSize:CGSizeMake(bubbleMaxWidth, CGFLOAT_MAX) options:NSStringDrawingUsesLineFragmentOrigin|NSStringDrawingUsesFontLeading attributes:@{NSFontAttributeName:textFont} context:nil]<span class="f1">.size</span>;<span class="f1">//            }else{</span>
<span class="f1">//                retSize = [text sizeWithFont:textFont constrainedToSize:CGSizeMake(bubbleMaxWidth, CGFLOAT_MAX) lineBreakMode:NSLineBreakByCharWrapping];</span>
<span class="f1">//            }</span>
<span class="f1">//            </span>
<span class="f1">//            </span>
<span class="f1">//</span>
                height += (<span class="f1">retSize</span><span class="f2">rect.size</span>.height &gt; 20 ? <span class="f1">retSize</span><span class="f2">rect.size</span>.height : 20) + 10;
            <span class="f2">}</span>
        }
            break;
        case EMMessageBodyTypeImage:
<span class="bold">diff --git a/EaseUI/EMUIKit/Views/conversation/toolbar/EaseChatToolbar.h b/EaseUI/EMUIKit/Views/conversation/toolbar/EaseChatToolbar.h</span>
<span class="bold">index 03d737f..d842ae4 100644</span>
<span class="bold">--- a/EaseUI/EMUIKit/Views/conversation/toolbar/EaseChatToolbar.h</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Views/conversation/toolbar/EaseChatToolbar.h</span>
<span class="f6">@@ -22,7 +22,8 @@</span>
#define kTouchToRecord NSEaseLocalizedString(@&quot;message.toolBar.record.touch&quot;, @&quot;hold down to talk&quot;)
#define kTouchToFinish NSEaseLocalizedString(@&quot;message.toolBar.record.send&quot;, @&quot;loosen to send&quot;)

<span class="f2">//BQMM集成</span>
<span class="f2">@class MMEmoji;</span>

@protocol EMChatToolbarDelegate;
@interface EaseChatToolbar : UIView
<span class="f6">@@ -91,6 +92,22 @@</span>

- (void)didSendText:(NSString *)text withExt:(NSDictionary*)ext;

<span class="f2">//BQMM集成</span>
<span class="f2">/**</span>
<span class="f2"> *  发送表情MM大表情</span>
<span class="f2"> *</span>
<span class="f2"> *  @param emoji 表情对象</span>
<span class="f2"> */</span>
<span class="f2">- (void)didSendMMFace:(MMEmoji *)emoji;</span>

<span class="f2">/**</span>
<span class="f2"> *  发送表情MM大表情</span>
<span class="f2"> *</span>
<span class="f2"> *  @param emoji 表情对象</span>
<span class="f2"> *  @param ext 扩展消息</span>
<span class="f2"> */</span>
<span class="f2">- (void)didSendMMFace:(MMEmoji *)emoji withExt:(NSDictionary*)ext;</span>

- (BOOL)didInputAtInLocation:(NSUInteger)location;

- (BOOL)didDeleteCharacterFromLocation:(NSUInteger)location;
<span class="bold">diff --git a/EaseUI/EMUIKit/Views/conversation/toolbar/EaseChatToolbar.m b/EaseUI/EMUIKit/Views/conversation/toolbar/EaseChatToolbar.m</span>
<span class="bold">index c6e9afc..85f2d72 100644</span>
<span class="bold">--- a/EaseUI/EMUIKit/Views/conversation/toolbar/EaseChatToolbar.m</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Views/conversation/toolbar/EaseChatToolbar.m</span>
<span class="f6">@@ -18,7 +18,10 @@</span>
#import &quot;EaseEmotionManager.h&quot;
#import &quot;EaseLocalDefine.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>
@interface EaseChatToolbar()&lt;UITextViewDelegate, EMFaceDelegate<span class="f2">, MMEmotionCentreDelegate</span>&gt;


@property (nonatomic) CGFloat version;
@property (strong, nonatomic) NSMutableArray *leftItems;
<span class="f6">@@ -91,7 +94,16 @@</span> - (instancetype)initWithFrame:(CGRect)frame
        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(chatKeyboardWillChangeFrame:) name:UIKeyboardWillChangeFrameNotification object:nil];

        [self _setupSubviews];
        <span class="f2">//BQMM集成</span>
<span class="f2">        [MMEmotionCentre defaultCentre].delegate = self;</span>
    }

    <span class="f2">//BQMM集成</span>
<span class="f2">    [[NSNotificationCenter defaultCenter] addObserver:self</span>
<span class="f2">                                             selector:@selector(backToUserInterface)</span>
<span class="f2">                                                 name:@&quot;SMEmotionDismissShopNotification&quot;</span>
<span class="f2">                                               object:nil];</span>

    return self;
}

<span class="f6">@@ -177,11 +189,16 @@</span> - (void)_setupSubviews
    EaseChatToolbarItem *moreItem = [[EaseChatToolbarItem alloc] initWithButton:self.moreButton withView:self.moreView];

    [self setInputViewRightItems:@[faceItem, moreItem]];

    <span class="f2">//BQMM集成</span>
<span class="f2">    [[MMEmotionCentre defaultCentre] shouldShowShotcutPopoverAboveView:self.faceButton withInput:self.inputTextView];</span>

}

- (void)dealloc
{
    <span class="f2">//BQMM集成</span>
    [[NSNotificationCenter defaultCenter] removeObserver:self<span class="f1">name:UIKeyboardWillChangeFrameNotification object:nil</span>];

    _delegate = nil;
    _inputTextView.delegate = nil;
<span class="f6">@@ -523,7 +540,8 @@</span> - (BOOL)textView:(UITextView *)textView shouldChangeTextInRange:(NSRange)range r
{
    if ([text isEqualToString:@&quot;\n&quot;]) {
        if ([self.delegate respondsToSelector:@selector(didSendText:)]) {
            <span class="f2">//BQMM集成</span>
            [self.delegate didSendText:textView.<span class="f1">text</span><span class="f2">mmText</span>];
            self.inputTextView.text = @&quot;&quot;;
            [self _willShowInputTextViewToHeight:[self _getTextViewContentH:self.inputTextView]];
        }
<span class="f6">@@ -549,6 +567,13 @@</span> - (BOOL)textView:(UITextView *)textView shouldChangeTextInRange:(NSRange)range r

- (void)textViewDidChange:(UITextView *)textView
{
    <span class="f2">//BQMM集成</span>
<span class="f2">    if (textView.markedTextRange == nil) {</span>
<span class="f2">        NSRange selectedRange = textView.selectedRange;</span>
<span class="f2">        textView.mmText = textView.mmText;</span>
<span class="f2">        textView.selectedRange = selectedRange;</span>
<span class="f2">    }</span>

    [self _willShowInputTextViewToHeight:[self _getTextViewContentH:textView]];
}

<span class="f6">@@ -720,19 +745,31 @@</span> - (void)faceButtonAction:(id)sender
        item.button.selected = NO;
    }

    <span class="f2">//BQMM集成</span>
<span class="f2">    //替换成表情MM键盘</span>
    if (button.selected) {
<span class="f1">[</span>        self.<span class="f1">inputTextView resignFirstResponder]</span><span class="f2">moreButton.selected = NO</span>;

        <span class="f1">[self _willShowBottomView:faceItem</span><span class="f2">if (!_inputTextView</span>.<span class="f1">button2View</span><span class="f2">isFirstResponder) {</span>
<span class="f2">            [_inputTextView becomeFirstResponder</span>];
        <span class="f2">}</span>
        [<span class="f1">UIView animateWithDuration:0.2 delay:0 options:UIViewAnimationOptionCurveEaseInOut animations</span><span class="f2">[MMEmotionCentre defaultCentre] attachEmotionKeyboardToInput</span>:<span class="f1">^{</span>
<span class="f1">            self.recordButton.hidden = button.selected</span><span class="f2">_inputTextView]</span>;
        self<span class="f1">.inputTextView.hidden = !button</span><span class="f2">.faceButton</span>.selected <span class="f2">= YES</span>;
    }
    <span class="f1">completion:^(BOOL finished)</span><span class="f2">else</span> {
        <span class="f1">}</span><span class="f2">[[MMEmotionCentre defaultCentre] switchToDefaultKeyboard</span>];
    }

<span class="f1">else</span><span class="f2">}</span>

<span class="f2">//BQMM集成</span>
<span class="f2">- (void)backToUserInterface</span> {<span class="f1">[</span>
    self.<span class="f1">inputTextView</span><span class="f2">moreButton.selected = NO;</span>
<span class="f2">    if (!_inputTextView.isFirstResponder) {</span>
<span class="f2">        [_inputTextView</span> becomeFirstResponder];
    }
    <span class="f2">[[MMEmotionCentre defaultCentre] attachEmotionKeyboardToInput:_inputTextView];</span>
<span class="f2">    self.faceButton.selected = YES;</span>
}

- (void)moreButtonAction:(id)sender
<span class="f6">@@ -842,4 +879,36 @@</span> - (void)willShowBottomView:(UIView *)bottomView
    [self _willShowBottomView:bottomView];
}

<span class="f2">//BQMM集成</span>
<span class="f2">//表情MM代理</span>
<span class="f2">#pragma mark - *MMEmotionCentreDelegate</span>
<span class="f2">- (void)didSelectEmoji:(MMEmoji *)emoji</span>
<span class="f2">{</span>
<span class="f2">    if ([self.delegate respondsToSelector:@selector(didSendMMFace:)]) {</span>
<span class="f2">        [self.delegate didSendMMFace:emoji];</span>
<span class="f2">    }</span>
<span class="f2">}</span>

<span class="f2">- (void)didSelectTipEmoji:(MMEmoji *)emoji</span>
<span class="f2">{</span>
<span class="f2">    if ([self.delegate respondsToSelector:@selector(didSendMMFace:)]) {</span>
<span class="f2">        [self.delegate didSendMMFace:emoji];</span>
<span class="f2">        self.inputTextView.text = @&quot;&quot;;</span>
<span class="f2">    }</span>
<span class="f2">}</span>

<span class="f2">- (void)didSendWithInput:(UIResponder&lt;UITextInput&gt; *)input</span>
<span class="f2">{</span>
<span class="f2">    if ([self.delegate respondsToSelector:@selector(didSendText:)]) {</span>
<span class="f2">        [self.delegate didSendText:_inputTextView.mmText];</span>
<span class="f2">        self.inputTextView.text = @&quot;&quot;;</span>
<span class="f2">        [self _willShowInputTextViewToHeight:[self _getTextViewContentH:_inputTextView]];</span>
<span class="f2">    }</span>
<span class="f2">}</span>

<span class="f2">- (void)tapOverlay</span>
<span class="f2">{</span>
<span class="f2">    self.faceButton.selected = NO;</span>
<span class="f2">}</span>

@end
<span class="bold">diff --git a/EaseUI/EMUIKit/Views/conversation/toolbar/EaseTextView.h b/EaseUI/EMUIKit/Views/conversation/toolbar/EaseTextView.h</span>
<span class="bold">index a487ceb..ff703ff 100644</span>
<span class="bold">--- a/EaseUI/EMUIKit/Views/conversation/toolbar/EaseTextView.h</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Views/conversation/toolbar/EaseTextView.h</span>
<span class="f6">@@ -12,6 +12,9 @@</span>

#import &lt;UIKit/UIKit.h&gt;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>

typedef NS_ENUM(NSUInteger, DXTextViewInputViewType) {
    DXTextViewNormalInputType = 0,
    DXTextViewTextInputType,
<span class="bold">diff --git a/EaseUI/EMUIKit/Views/conversation/toolbar/EaseTextView.m b/EaseUI/EMUIKit/Views/conversation/toolbar/EaseTextView.m</span>
<span class="bold">index 9175469..618ed85 100644</span>
<span class="bold">--- a/EaseUI/EMUIKit/Views/conversation/toolbar/EaseTextView.m</span>
<span class="bold">+++ b/EaseUI/EMUIKit/Views/conversation/toolbar/EaseTextView.m</span>
<span class="f6">@@ -82,6 +82,24 @@</span> - (void)setTextAlignment:(NSTextAlignment)textAlignment {
    [self setNeedsDisplay];
}

<span class="f2">//BQMM集成</span>
<span class="f2">- (void)copy:(id)sender</span>
<span class="f2">{</span>
<span class="f2">    [UIPasteboard generalPasteboard].string = [self mmTextWithRange:self.selectedRange];</span>
<span class="f2">}</span>

<span class="f2">- (void)cut:(id)sender</span>
<span class="f2">{</span>
<span class="f2">    [UIPasteboard generalPasteboard].string = [self mmTextWithRange:self.selectedRange];</span>
<span class="f2">    NSRange range  = [self.mmText rangeOfString:[UIPasteboard generalPasteboard].string];</span>
<span class="f2">    NSString *left = [self.mmText substringToIndex:range.location];</span>
<span class="f2">    NSString *right = [self.mmText substringFromIndex:range.location + range.length];</span>
<span class="f2">    NSRange selectedRange = self.selectedRange;</span>
<span class="f2">    self.mmText = [NSString stringWithFormat:@&quot;%@%@&quot;, left, right];</span>
<span class="f2">    self.selectedRange = NSMakeRange(selectedRange.location, 0);</span>
<span class="f2">    [self.delegate textViewDidChange:self];</span>
<span class="f2">}</span>

#pragma mark - Notifications

- (void)didReceiveTextDidChangeNotification:(NSNotification *)notification {
</pre>
</body>
</html>
